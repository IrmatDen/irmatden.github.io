<html>
    <head>
        <title>Ce qu'il nous reste - Sheet</title>
        <style>
            .container {
                display: table;
                border-spacing: 5px;
            }
            .row {
                display: table-row;
            }
            .inner-table {
                display: inline;
            }
            label, input {
                display: table-cell;
            }
            .expertise {
                background-color: #B3EBF2;
                float: left;
                width: 270px;
                padding: 5px;
                border-spacing: 5px;
            }
            .signs {
                background-color: #9bdbad;
                float: left;
                width: 270px;
                padding: 5px;
                border-spacing: 5px;
            }
            .marks {
                background-color: #FF746C;
                float: left;
                width: 270px;
                padding: 5px;
                border-spacing: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <label>Player name:</label>
                <input type="text" id="player" />
            </div>
            <div class="row">
                <label>Campaign name:</label>
                <input type="text" id="campaign" />
            </div>
            <div class="row">
                <label>Character name:</label>
                <input type="text" id="name" />
            </div>
            <div class="row">
                <label>Concept:</label>
                <input type="text" id="concept" />
            </div>
            <div class="row">
                <label>Portrait:</label>
                <input type="file" id="portrait" accept="image/png, image/jpeg" />
            </div>
        </div>

        <div class="container">
            <!-- Expertises -->
            <div class="expertise">
                <div class="inner-table">
                    <label>Eclat #1:</label>
                    <input type="text" id="expertise-1" />
                </div><br/>
                <div class="inner-table">
                    <label>Eclat #2:</label>
                    <input type="text" id="expertise-2" />
                </div><br/>
                <div class="inner-table">
                    <label>Eclat #3:</label>
                    <input type="text" id="expertise-3" />
                </div>
            </div>

            <!-- Signs -->
            <div class="signs">
                <div class="inner-table">
                    <label>Signes #1:</label>
                    <input type="text" id="sign-1" />
                </div><br/>
                <div class="inner-table">
                    <label>Signes #2:</label>
                    <input type="text" id="sign-2" />
                </div><br/>
                <div class="inner-table">
                    <label>Signes #3:</label>
                    <input type="text" id="sign-3" />
                </div>
            </div>

            <!-- Marks -->
            <div class="marks">
                <div class="inner-table">
                    <label>Marques #1:</label>
                    <input type="text" id="mark-1" />
                </div><br/>
                <div class="inner-table">
                    <label>Marques #2:</label>
                    <input type="text" id="mark-2" />
                </div><br/>
                <div class="inner-table">
                    <label>Marques #3:</label>
                    <input type="text" id="mark-3" />
                </div>
            </div>
        </div>

        <div>
            <button id="generate-sheet">Generate sheet PDF</button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
        <script src="./Ink Free-normal.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const { jsPDF } = window.jspdf;

                const v = function(id) {
                    return $("#" + id).val();
                };

                const genPdf = function(
                    /*string[]*/ expertise = [],
                    /*string[]*/ marks = [],
                    /*string[]*/ signs = [],
                    /*string*/ name,
                    /*string*/ concept,
                    /*string*/ player,
                    /*string*/ campaign,
                    /*string*/ portrait,

                ) {
                    const doc = new jsPDF({ orientation: "landscape", format: "a4", unit: "mm" });

                    if (!portrait) {
                        doc.addImage("default-fantasy-male-portrait.png", "PNG", 8, 81, 64, 93, "SLOW");
                    }
                    else {
                        const props = doc.getImageProperties(portrait);
                        // fit
                        const defaultWidth = 64;
                        const defaultHeight = 93;

                        var x = 8;
                        var y = 81;
                        var width = defaultWidth;
                        var height = defaultHeight;
                        if (props.height > props.width) {
                            height = (props.height * width) / props.width;
                            if (height < defaultHeight) {
                                y += (defaultHeight - height) / 2;
                            } else {
                                const diff = defaultHeight / height;
                                const ratio = (1 - diff) / 2;
                                y -= ratio * height;
                            }
                        } else {
                            width = (props.width * height) / props.height;
                            if (width < defaultWidth) {
                                x += (defaultWidth - width) / 2;
                            } else {
                                const diff = defaultWidth / width;
                                const ratio = (1 - diff) / 2;
                                x -= ratio * width;
                            }
                        }
                        doc.addImage(portrait, "PNG", x, y, width, height, "SLOW");
                    }

                    doc.addImage("CQNR-sheet.png", "PNG", 0, 0, 297, 210, "", "SLOW");
                    doc.setFont("Ink Free");

                    doc.setFontSize(20);
                    expertise.forEach((e, index) => {
                        doc.text(e, 11, 11.5 + index * 12);
                    });
                    
                    doc.setFontSize(16);
                    marks.forEach((m, index) => {
                        doc.text(m, 11, 54 + index * 9.5);
                    });
                    
                    doc.setFontSize(14);
                    signs.forEach((s, index) => {
                        doc.text(s, 123, 151 + index * 9.5, { align: "center" });
                    });

                    doc.setFontSize(24);
                    doc.text(name, 40.1, 183, { align: "center" });

                    doc.setFontSize(18);
                    doc.text(concept, 84, 200, { align: "center" });

                    doc.text(player, 254, 13, { align: "center" });

                    doc.setFontSize(16);
                    doc.text(campaign, 219, 26);

                    doc.save('CQNR-' + name + '.pdf');
                };
    
                document.getElementById('generate-sheet').addEventListener('click', function() {
                    const portraitPath = $("#portrait")[0].files.length > 0 ? $("#portrait")[0].files[0] : null;
                    if (portraitPath) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const portraitBlob = e.target.result;
                            genPdf(
                                [v("expertise-1"), v("expertise-2"), v("expertise-3")],
                                [v("mark-1"), v("mark-2"), v("mark-3")],
                                [v("sign-1"), v("sign-2"), v("sign-3")],
                                v("name"),
                                v("concept"),
                                v("player"),
                                v("campaign"),
                                portraitBlob
                                );
                        };
                        reader.readAsDataURL(portraitPath);
                    } else {
                        genPdf(
                                [v("expertise-1"), v("expertise-2"), v("expertise-3")],
                                [v("mark-1"), v("mark-2"), v("mark-3")],
                                [v("sign-1"), v("sign-2"), v("sign-3")],
                                v("name"),
                                v("concept"),
                                v("player"),
                                v("campaign"),
                                null
                                );
                    }
                });
            });
        </script>
    </body>
</html>